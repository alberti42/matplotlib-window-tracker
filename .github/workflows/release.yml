name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tooling
        run: |
          python -m pip install -U pip
          python -m pip install build twine

      - name: Verify tag matches project version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          PYPROJECT_VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
          echo "tag version: ${TAG}"
          echo "pyproject.toml version: ${PYPROJECT_VERSION}"
          test "${TAG}" = "${PYPROJECT_VERSION}"

      - name: Build sdist and wheel
        run: python -m build

      - name: Check distributions
        run: python -m twine check dist/*

      - name: Install and run tests (headless)
        run: |
          python -m pip install -e ".[test]"
          MPLBACKEND=Agg python -m pytest

      - name: Build agent docs bundle (README + SKILL)
        shell: bash
        run: |
          set -euo pipefail
          bundle_dir="${RUNNER_TEMP}/matplotlib-window-tracker"
          rm -rf "${bundle_dir}"
          mkdir -p "${bundle_dir}"
          cp README.md "${bundle_dir}/README.md"
          cp skills/matplotlib-window-tracker/SKILL.md "${bundle_dir}/SKILL.md"

          python - <<'PY'
          from __future__ import annotations

          import os
          import pathlib
          import zipfile

          bundle_dir = pathlib.Path(os.environ["RUNNER_TEMP"]) / "matplotlib-window-tracker"
          zip_path = pathlib.Path("dist") / "matplotlib-window-tracker-agent-skill.zip"
          zip_path.parent.mkdir(parents=True, exist_ok=True)

          with zipfile.ZipFile(zip_path, "w", compression=zipfile.ZIP_DEFLATED) as zf:
              for p in bundle_dir.rglob("*"):
                  if p.is_file():
                      zf.write(p, arcname=str(p.relative_to(bundle_dir.parent)))
          print(f"Wrote {zip_path}")
          PY

      - name: Compute release changelog link
        id: changelog
        shell: bash
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          cur="${GITHUB_REF_NAME}"

          notes_file="release-notes/${cur}.md"
          if [[ ! -f "${notes_file}" ]]; then
            echo "Missing release notes: ${notes_file}" >&2
            echo "Create it before tagging a release." >&2
            exit 1
          fi

          # Best-effort previous tag (first release may have none).
          prev=""
          if git describe --tags --abbrev=0 --match 'v*' "${GITHUB_SHA}^" >/dev/null 2>&1; then
            prev="$(git describe --tags --abbrev=0 --match 'v*' "${GITHUB_SHA}^")"
          fi

          if [[ -n "${prev}" ]]; then
            url="https://github.com/${repo}/compare/${prev}...${cur}"
            changelog_line="Full changelog: ${url}"
          else
            url="https://github.com/${repo}/commits/${cur}"
            changelog_line="Full changelog: ${url}"
          fi

          out_file="${RUNNER_TEMP}/release_body_${cur}.md"
          cat "${notes_file}" > "${out_file}"
          printf "\n%s\n" "${changelog_line}" >> "${out_file}"

          printf 'body_path=%s\n' "${out_file}" >> "${GITHUB_OUTPUT}"

      - name: Create GitHub Release and upload artifacts
        uses: softprops/action-gh-release@v2
        with:
          body_path: ${{ steps.changelog.outputs.body_path }}
          files: |
            dist/*.tar.gz
            dist/*.whl
            dist/matplotlib-window-tracker-agent-skill.zip
